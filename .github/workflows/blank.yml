name: SSH Connect with PEM Key (Windows Runner)

on:
  push:
    branches:
      - main

jobs:
  ssh-job:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          # Создание директории для SSH ключа
          mkdir -p $env:USERPROFILE\.ssh
          
          # Преобразование секрета в файл
          Set-Content -Path $env:USERPROFILE\.ssh\id_rsa -Value "${{ secrets.ssh_key }}"
          
          # Установка прав доступа
          icacls $env:USERPROFILE\.ssh\id_rsa /inheritance:r /grant:r "${env:USERNAME}:(R,W)"
          
          # Добавление ключа сервера в known_hosts
          ssh-keyscan -H 20.107.247.116 >> $env:USERPROFILE\.ssh\known_hosts

      - name: Run remote SSH command
        run: |
          # Запуск SSH с указанием ключа
          ssh -i $env:USERPROFILE\.ssh\id_rsa imbydata@20.107.247.116 "echo Hello from server && uptime"
